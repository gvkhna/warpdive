---
import AuthLayout from '@layouts/AuthLayout.astro'
import CircleLoader from '@/components/CircleLoader.astro'
import {deleteFlashCookie, deleteOauthStateCookie, deleteUserAuthCookie, setFlashCookie} from '@/lib/cookies'

import HomeLayout from '@/layouts/HomeLayout.astro'
import {drizzle} from 'drizzle-orm/d1'
import {eq} from 'drizzle-orm'
import * as schema from '@/db/schema'
import {decode, sign, verify} from 'hono/jwt'
import {getUserAuthCookie} from '@/lib/cookies'

const userAuthCookie = getUserAuthCookie(Astro)
export const prerender = false

let displayError: Error | undefined = undefined

if (userAuthCookie) {
  const db = drizzle(Astro.locals.runtime.env.DB, {schema})
  const result = await db.delete(schema.userSessions).where(eq(schema.userSessions.sessionToken, userAuthCookie))

  console.log('signout res: ', result)
}
deleteOauthStateCookie(Astro)
deleteUserAuthCookie(Astro)
deleteFlashCookie(Astro)
---

<AuthLayout title='Signout'>
  <div class='fixed inset-0 z-10 overflow-y-auto'>
    <div
      class='align-items-center flex min-h-screen items-end justify-center px-4 pb-20 pt-4 text-center sm:block sm:p-0'
    >
      <div
        class='fixed inset-0 transition-opacity'
        aria-hidden='true'
      >
        <div class='absolute inset-0 bg-gray-200 opacity-75'></div>
      </div>

      <span
        class='hidden sm:inline-block sm:h-screen sm:align-middle'
        aria-hidden='true'
      >
        &#8203;
      </span>
      <div
        class='inline-block flex-1 transform overflow-hidden rounded-sm bg-white px-4 pb-4 pt-5 text-left align-bottom shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-sm sm:p-6 sm:align-middle'
        role='dialog'
        aria-modal='true'
        aria-labelledby='modal-headline'
      >
        <>
          <div>
            <div class='mx-auto flex h-12 w-12 items-center justify-center rounded-full'>
              <CircleLoader class='h-15 w-15 text-black' />
            </div>
            <div class='mt-3 text-center sm:mt-5'>
              <h3
                class='text-lg font-medium leading-6 text-gray-900'
                id='modal-headline'
              >
                Signing out
              </h3>
              <div class='mt-2'>
                <p class='text-sm text-gray-600'>
                  Redirecting to <a
                    class='font-medium text-indigo-500 hover:text-indigo-600'
                    href='/signin'
                  >
                    Signin
                  </a>...
                </p>
              </div>
            </div>
          </div>
        </>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        window.location.replace('/signin/')
      }, 3500)
    })
  </script>
</AuthLayout>
